#
# nnue-pytorch training steps
#
training:
  steps:
#
# S1
#
    - trainer:
        owner: vondele
        sha: a1e061384917a089520cc16b6ead6dde4047afdd
      run:
        resume: none
        max_epochs: 18
        binpacks:
          - official-stockfish/master-binpacks/test80-2022-08-aug-16tb7p.v6-dd.min.binpack
        other_options:
          - --batch-size=16384
          - --features=HalfKAv2_hm^
          - --l1=128
          - --random-fen-skipping=3
          - --lr=4.375e-4
          - --gamma=0.9950
          - --early-fen-skipping=3
          - --epoch-size=100000
          - --validation-size=0
      convert:
        checkpoint2nnue:
          - --features=HalfKAv2_hm^
          - --l1=128
          - --ft_compression=leb128
#
# S2
#
    - trainer:
        owner: vondele
        sha: a1e061384917a089520cc16b6ead6dde4047afdd
      run:
        resume: previous_checkpoint
        repetitions: 2
        max_epochs: 20
        binpacks:
          - official-stockfish/master-binpacks/test80-2022-08-aug-16tb7p.v6-dd.min.binpack
        other_options:
          - --batch-size=16384
          - --features=HalfKAv2_hm^
          - --l1=128
          - --random-fen-skipping=3
          - --lr=4.375e-4
          - --gamma=0.995
          - --early-fen-skipping=2
          - --epoch-size=100000
          - --validation-size=0
      convert:
        checkpoint2nnue:
          - --features=HalfKAv2_hm^
          - --l1=128
          - --ft_compression=leb128
#
# S3
#
    - trainer:
        owner: vondele
        sha: a1e061384917a089520cc16b6ead6dde4047afdd
      run:
        resume: previous_model
        max_epochs: 12
        binpacks:
          - official-stockfish/master-binpacks/test80-2022-08-aug-16tb7p.v6-dd.min.binpack
        other_options:
          - --batch-size=16384
          - --features=HalfKAv2_hm^
          - --l1=128
          - --random-fen-skipping=3
          - --lr=4.375e-4
          - --gamma=0.995
          - --early-fen-skipping=2
          - --epoch-size=100000
          - --validation-size=0
          - --pc-y1=1.0
          - --pc-y2=3.0
          - --pc-y3=1.5
          - --w1=3.0
          - --w2=0.7
      convert:
        binpack: official-stockfish/master-binpacks/fishpack32.binpack
        optimize:
          - --features=HalfKAv2_hm
          - --l1=128
          - --ft_optimize_count=10000
          - --ft_optimize
          - --ft_compression=leb128
        checkpoint2nnue:
          - --features=HalfKAv2_hm^
          - --l1=128
          - --ft_compression=leb128
#
# Final testing stage using fastchess
#
testing:
  steps: all
  reference:
    code:
      owner: official-stockfish
      sha: 5297ba0a1a1aa0a15332e0d64ce6b32952342cac
      target: build
  testing:
    code:
      owner: official-stockfish
      sha: 5297ba0a1a1aa0a15332e0d64ce6b32952342cac
      target: profile-build
  fastchess:
    code:
      owner: Disservin
      sha: 54cfa83972ba64032ef634198eef498508d115c6
    options:
#       tc: 10+0.1
       nodes: 10000
       hash: 16
       evalfile: small
       max_rounds: 100
#    sprt:
#       # midpoint will be the target to reach, relative to reference, to have a passing CI
#       nElo_interval_midpoint: 0
#       nElo_interval_width: 10
