name: Comment YAML Diff Links

on:
  pull_request_target:
    paths:
      - "*.yaml"
      - "*.yml"
    types: [opened, synchronize]

jobs:
  comment-diff-links:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Get changed YAML files and extract trainer/stockfish info
        id: changed-files
        shell: python
        run: |
          import yaml
          import json
          import subprocess
          import os

          # Get changed files - Using fetch-depth 0 ensures these SHAs exist
          base_sha = '${{ github.event.pull_request.base.sha }}'
          head_sha = '${{ github.event.pull_request.head.sha }}'
          
          result = subprocess.run(
              ['git', 'diff', '--name-only', base_sha, head_sha],
              capture_output=True, text=True
          )
          changed_files = [f for f in result.stdout.strip().split('\n') if f and f.endswith(('.yaml', '.yml'))]

          trainer_changes = []
          stockfish_changes = []

          for file in changed_files:
              # Get old content from base branch
              try:
                  old_result = subprocess.run(
                      ['git', 'show', f'{base_sha}:{file}'],
                      capture_output=True, text=True
                  )
                  old_content = yaml.safe_load(old_result.stdout) if old_result.returncode == 0 else {}
              except:
                  old_content = {}
              
              # Get new content from workspace
              try:
                  with open(file, 'r') as f:
                      new_content = yaml.safe_load(f)
              except:
                  new_content = {}
              
              # Extract trainers from training steps
              old_steps = (old_content or {}).get('training', {}).get('steps', [])
              new_steps = (new_content or {}).get('training', {}).get('steps', [])
              
              max_steps = max(len(old_steps), len(new_steps))
              for i in range(max_steps):
                  old_step = old_steps[i] if i < len(old_steps) else {}
                  new_step = new_steps[i] if i < len(new_steps) else {}
                  
                  old_trainer = old_step.get('trainer', {})
                  new_trainer = new_step.get('trainer', {})
                  
                  old_sha = old_trainer.get('sha', '')
                  new_sha = new_trainer.get('sha', '')
                  new_owner = new_trainer.get('owner', 'official-stockfish')
                  
                  if new_sha and old_sha != new_sha:
                      trainer_changes.append({
                          'file': file,
                          'step': i + 1,
                          'old_sha': old_sha,
                          'new_sha': new_sha,
                          'owner': new_owner
                      })

              # Extract Stockfish reference/testing
              new_testing = (new_content or {}).get('testing', {})
              old_testing = (old_content or {}).get('testing', {})

              for key in ['reference', 'testing']:
                  old_sha = old_testing.get(key, {}).get('code', {}).get('sha', '')
                  new_section = new_testing.get(key, {}).get('code', {})
                  new_sha = new_section.get('sha', '')
                  
                  if new_sha and old_sha != new_sha:
                      stockfish_changes.append({
                          'file': file,
                          'type': key,
                          'old_sha': old_sha,
                          'new_sha': new_sha,
                          'owner': new_section.get('owner', 'official-stockfish')
                      })

          # Write to GITHUB_OUTPUT using environment file
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"has_changes={'true' if changed_files else 'false'}\n")
              f.write(f"trainer_json={json.dumps(trainer_changes)}\n")
              f.write(f"stockfish_json={json.dumps(stockfish_changes)}\n")

      - name: Comment PR with diff links
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          TRAINER_DATA: ${{ steps.changed-files.outputs.trainer_json }}
          STOCKFISH_DATA: ${{ steps.changed-files.outputs.stockfish_json }}
        with:
          script: |
            const trainerChanges = JSON.parse(process.env.TRAINER_DATA || '[]');
            const stockfishChanges = JSON.parse(process.env.STOCKFISH_DATA || '[]');

            if (trainerChanges.length === 0 && stockfishChanges.length === 0) return;

            let body = '## ðŸ” Configuration Changes Detected\n\n';

            if (trainerChanges.length > 0) {
              body += '### ðŸ§  Trainer Changes (nnue-pytorch)\n';
              for (const change of trainerChanges) {
                const stepLabel = `Step ${change.step}`;
                if (change.old_sha) {
                  body += `- **${change.file}** (${stepLabel}): [${change.old_sha.substring(0, 7)}...${change.new_sha.substring(0, 7)}](https://github.com/${change.owner}/nnue-pytorch/compare/${change.old_sha}...${change.new_sha})\n`;
                } else {
                  body += `- **${change.file}** (${stepLabel}): New trainer [${change.new_sha.substring(0, 7)}](https://github.com/${change.owner}/nnue-pytorch/commit/${change.new_sha})\n`;
                }
              }
              body += '\n';
            }

            if (stockfishChanges.length > 0) {
              body += '### â™Ÿï¸ Stockfish Changes\n';
              for (const change of stockfishChanges) {
                const typeLabel = change.type.charAt(0).toUpperCase() + change.type.slice(1);
                if (change.old_sha) {
                  body += `- **${change.file}** (${typeLabel}): [${change.old_sha.substring(0, 7)}...${change.new_sha.substring(0, 7)}](https://github.com/${change.owner}/Stockfish/compare/${change.old_sha}...${change.new_sha})\n`;
                } else {
                  body += `- **${change.file}** (${typeLabel}): New [${change.new_sha.substring(0, 7)}](https://github.com/${change.owner}/Stockfish/commit/${change.new_sha})\n`;
                }
              }
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Configuration Changes Detected')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
